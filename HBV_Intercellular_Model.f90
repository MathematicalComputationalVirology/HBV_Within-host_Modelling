MODULE define_DDEs

  IMPLICIT NONE

  INTEGER, PARAMETER :: NEQN=808,NLAGS=1

  ! Physical parameters assigned in the main program.
  ! DOUBLE PRECISION :: tau,omega

CONTAINS

  SUBROUTINE DDES(T,Y,Z,DY)
    IMPLICIT NONE
    DOUBLE PRECISION :: T
    DOUBLE PRECISION, DIMENSION(:) :: Y,DY
    DOUBLE PRECISION, DIMENSION(:,:) :: Z
    INTENT(IN)  :: T,Y,Z
    INTENT(OUT) :: DY
   
    ! Physical parameters
    DOUBLE PRECISION :: rT,Tm,dc,kf,kb,di,dxx,Am,dA,bet,delt,m,rh1,rh2
    DOUBLE PRECISION :: pA,rA,lamE,alph,ph1,ph2,ks,qc,dE,kapp,dq,rho,eps,eta
    INTEGER :: n
    ! Local variables
    DOUBLE PRECISION :: Yall,Itau,Zc,Zi,theta,meta
    INTEGER :: ii,jj,kk,j,i1,i2
    DOUBLE PRECISION, DIMENSION(801) :: Pc,Pi
    rT = 0.01d0
    Tm = 4.0d+5
    dc = 0.67
    kf = 1.0d-10
    kb = 10.0d0
    di = 0.67
    dxx = 2.7
    Am = 3.4d+12
    dA = 0.033
    
    bet = 1.25d-9
    m = 1.4d-4
    
    delt = 0.0175
    rh1 = 3.35d0
    rh2 = 0.7d0
    pA = 1.0d-4
    rA = 0.3805d0
    lamE = 10.0d0
    alph = 1.8d0
    ph1 = 1d+6
    ph2 = 1d+6
    ks = 1d0
    qc = 10
    dE = 0.5d0
    !kapp = 1.0d0
    dq = 0.1d0
    n = 3
    rho = 0.0d0
    
    !!!!! treatment !!!!!!
    IF ((T .GE. 130d0) .AND. (T .LE. 466d0)) THEN
        eta = 0.0d0 !150 to 486
        eps = 0.0d0
        kapp = 1d0 !100 to 150 is enough
    ELSE
        eta = 0.0d0
        eps = 0.0d0
        kapp = 1d0
    ENDIF

    Pc = (/ 0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0&
    ,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0,0d0&
    ,0d0,0.000329218d0,0.00131687d0,0.00296296d0,0.00526749d0,0.00855967d0,0.0128395d0,0.018107d0,0.0250206d0&
    ,0.0339095d0,0.043786d0,0.0536626d0,0.0638683d0,0.0753909d0,0.0879012d0,0.101399d0,0.115885d0,0.129712d0&
    ,0.142551d0,0.155391d0,0.169218d0,0.183374d0,0.195556d0,0.205761d0,0.213992d0,0.221235d0,0.228807d0,0.237366d0&
    ,0.246914d0,0.257778d0,0.270617d0,0.287737d0,0.308807d0,0.335144d0,0.364444d0,0.396379d0,0.428313d0,0.460247d0&
    ,0.492181d0,0.523457d0,0.552757d0,0.580741d0,0.605432d0,0.629136d0,0.651852d0,0.678519d0,0.709794d0,0.743045d0&
    ,0.780576d0,0.822387d0,0.867819d0,0.918189d0,0.974156d0,1.03737d0,1.10321d0,1.16741d0,1.23391d0,1.29844d0&
    ,1.36395d0,1.4321d0,1.4986d0,1.55786d0,1.60658d0,1.64609d0,1.68362d0,1.7149d0,1.74222d0,1.76d0,1.76626d0&
    ,1.76823d0,1.77383d0,1.78601d0,1.80708d0,1.83012d0,1.85942d0,1.89728d0,1.94667d0,2.01119d0,2.08922d0,2.17284d0&
    ,2.25909d0,2.3414d0,2.42436d0,2.50634d0,2.58305d0,2.6558d0,2.71638d0,2.75885d0,2.79078d0,2.81778d0,2.85004d0&
    ,2.88724d0,2.92971d0,2.98206d0,3.04395d0,3.1223d0,3.22173d0,3.33827d0,3.46239d0,3.58551d0,3.70502d0,3.81893d0&
    ,3.92395d0,4.01679d0,4.0958d0,4.16d0,4.20905d0,4.25383d0,4.29794d0,4.33975d0,4.37926d0,4.41317d0,4.44576d0&
    ,4.47967d0,4.51621d0,4.55802d0,4.59654d0,4.63078d0,4.66634d0,4.70683d0,4.76214d0,4.82765d0,4.90008d0,4.97909d0&
    ,5.05778d0,5.13942d0,5.227d0,5.32082d0,5.41893d0,5.50979d0,5.59737d0,5.6823d0,5.7656d0,5.85646d0,5.95984d0&
    ,6.07276d0,6.18897d0,6.3065d0,6.43621d0,6.58008d0,6.73646d0,6.90206d0,7.06831d0,7.22667d0,7.37646d0,7.52132d0&
    ,7.66519d0,7.79951d0,7.91934d0,8.02535d0,8.11885d0,8.213d0,8.30848d0,8.40395d0,8.50272d0,8.60444d0,8.71342d0&
    ,8.83062d0,8.96263d0,9.11309d0,9.26255d0,9.4163d0,9.57728d0,9.73597d0,9.88016d0,10.0086d0,10.1218d0,10.2133d0&
    ,10.2795d0,10.3394d0,10.3951d0,10.453d0,10.5235d0,10.6301d0,10.7737d0,10.9557d0,11.1707d0,11.4133d0,11.6701d0&
    ,11.9315d0,12.184d0,12.426d0,12.6364d0,12.8194d0,12.9699d0,13.1035d0,13.229d0,13.3537d0,13.4848d0,13.623d0&
    ,13.763d0,13.9121d0,14.0579d0,14.2081d0,14.3453d0,14.4649d0,14.563d0,14.6403d0,14.7068d0,14.7615d0,14.8072d0&
    ,14.8632d0,14.9337d0,15.0314d0,15.1664d0,15.3452d0,15.5612d0,15.8183d0,16.1261d0,16.4803d0,16.8523d0,17.2122d0&
    ,17.5486d0,17.843d0,18.0767d0,18.2545d0,18.3552d0,18.3661d0,18.2788d0,18.1192d0,17.918d0,17.677d0,17.4008d0&
    ,17.1022d0,16.7756d0,16.4309d0,16.0754d0,15.7202d0,15.3528d0,14.96d0,14.5501d0,14.1373d0,13.7238d0,13.3149d0&
    ,12.9172d0,12.5264d0,12.1435d0,11.7712d0,11.411d0,11.0617d0,10.717d0,10.3743d0,10.0382d0,9.70305d0,9.3814d0&
    ,9.07325d0,8.78354d0,8.52016d0,8.27951d0,8.05663d0,7.85119d0,7.65959d0,7.48477d0,7.3149d0,7.14568d0,6.97449d0&
    ,6.79605d0,6.61169d0,6.42601d0,6.24461d0,6.06255d0,5.88082d0,5.70107d0,5.52955d0,5.36527d0,5.21021d0,5.067d0&
    ,4.93564d0,4.80922d0,4.693d0,4.5837d0,4.4879d0,4.39638d0,4.31276d0,4.23111d0,4.14551d0,4.05531d0,3.96379d0&
    ,3.8749d0,3.78897d0,3.70337d0,3.62272d0,3.54239d0,3.47029d0,3.41399d0,3.37317d0,3.34519d0,3.32214d0,3.30502d0&
    ,3.29021d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0&
    ,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0,3.28033d0 /)
    
    Pi = (/ 77.28d0,406.8d0,757.44d0,1110.24d0,1454.64d0,1782.48d0,2130.24d0,2508.48d0,2819.28d0,3201.12d0,3510d0&
    ,3879.36d0,4196.88d0,4524d0,4911.6d0,5263.68d0,5591.52d0,5923.44d0,6266.64d0,6676.08d0,6919.2d0,7332.48d0&
    ,7670.88d0,8045.28d0,8394.24d0,8704.08d0,9101.76d0,9408.72d0,9764.64d0,10061.5d0,10468.6d0,10805.5d0,11111d0&
    ,11487.1d0,11909.8d0,12194.9d0,12570.5d0,12859.4d0,13262.4d0,13599.4d0,13935.6d0,14288.4d0,14624.6d0,14994.2d0&
    ,15340.6d0,15626.6d0,16055.5d0,16384.8d0,16713.4d0,17151.1d0,17404.3d0,17674.1d0,18193.4d0,18481.4d0,18831.1d0&
    ,19174.8d0,19461.6d0,19876.1d0,20242.1d0,20562.2d0,20942.2d0,21257.8d0,21541d0,21940.1d0,22276.3d0,22615d0&
    ,22858.1d0,23226.5d0,23509.7d0,23790.2d0,24069.6d0,24460.3d0,24637.7d0,25005.4d0,25250.2d0,25494.2d0,25909d0&
    ,26215.2d0,26573.8d0,26869.4d0,27109.2d0,27476.6d0,27882.7d0,28121.5d0,28596.5d0,28825.4d0,29112.2d0,29520d0&
    ,29850d0,30211.7d0,30480.7d0,30855.1d0,31227.1d0,31435d0,31850.6d0,32085.1d0,32401.7d0,32716.3d0,33123.6d0&
    ,33321.4d0,33520.3d0,34052.4d0,34168.3d0,34514.2d0,34777.4d0,34976.2d0,35202.7d0,35601.1d0,35801.3d0,35937.8d0&
    ,36234d0,36424.3d0,36615.1d0,36692.9d0,36973.9d0,37159.2d0,37229.5d0,37343.5d0,37390.8d0,37570.3d0,37554.7d0&
    ,37543.4d0,37520.4d0,37481.5d0,37418.2d0,37197.1d0,37296.2d0,36758.4d0,36756d0,36431.5d0,36068.2d0,35652.2d0&
    ,35167.4d0,34682.6d0,34098d0,33416.4d0,33045.4d0,32220d0,31482.5d0,30605.8d0,29653d0,28694.9d0,27704.9d0&
    ,26846.6d0,25664.6d0,24512.4d0,23245d0,21882.2d0,20705.8d0,19651.9d0,18314.9d0,16989.4d0,16107.8d0,14918.4d0&
    ,13591.7d0,12435.1d0,11426.4d0,10433.5d0,9402.48d0,8591.76d0,7882.56d0,7160.64d0,6518.16d0,5907.6d0,5371.68d0&
    ,4829.52d0,4419.84d0,4026.24d0,3710.4d0,3411.36d0,3096.96d0,2910d0,2729.52d0,2504.64d0,2386.56d0,2294.64d0&
    ,2166.48d0,2050.56d0,2005.44d0,1936.32d0,1842.48d0,1803.12d0,1776d0,1718.88d0,1725.12d0,1673.28d0,1651.92d0&
    ,1638d0,1615.2d0,1619.28d0,1645.92d0,1583.52d0,1570.08d0,1584.96d0,1576.08d0,1569.84d0,1593.6d0,1560.72d0&
    ,1557.6d0,1556.88d0,1568.4d0,1568.16d0,1594.08d0,1562.88d0,1583.76d0,1537.68d0,1591.68d0,1540.32d0,1564.32d0&
    ,1565.04d0,1542.72d0,1535.04d0,1517.28d0,1532.64d0,1528.32d0,1569.12d0,1557.12d0,1595.28d0,1545.6d0,1529.76d0&
    ,1578d0,1537.44d0,1516.32d0,1497.36d0,1558.8d0,1505.04d0,1522.8d0,1551.6d0,1511.52d0,1499.52d0,1515.6d0&
    ,1479.36d0,1512.96d0,1499.28d0,1477.92d0,1458.96d0,1458.24d0,1499.28d0,1478.88d0,1420.8d0,1462.8d0,1446d0&
    ,1434.48d0,1413.6d0,1441.92d0,1427.76d0,1375.2d0,1363.44d0,1369.2d0,1376.4d0,1371.12d0,1345.2d0,1311.84d0&
    ,1318.08d0,1328.88d0,1284.48d0,1273.2d0,1281.84d0,1282.08d0,1208.4d0,1223.52d0,1182.24d0,1154.64d0,1123.92d0&
    ,1137.6d0,1097.76d0,1078.8d0,1088.64d0,1035.6d0,1003.44d0,978.24d0,930d0,929.04d0,918.48d0,888.96d0,897.36d0&
    ,858.72d0,843.36d0,813.36d0,804.48d0,780.24d0,775.2d0,751.44d0,742.32d0,725.52d0,707.28d0,685.92d0,703.2d0&
    ,703.2d0,687.36d0,652.32d0,648.96d0,641.04d0,629.28d0,598.56d0,599.76d0,586.56d0,580.08d0,555.84d0,560.4d0&
    ,533.76d0,540.24d0,527.04d0,540.96d0,498d0,512.16d0,491.52d0,485.52d0,486.96d0,484.08d0,457.68d0,460.32d0&
    ,461.76d0,458.16d0,442.8d0,426.96d0,437.28d0,406.56d0,413.76d0,411.36d0,429.12d0,410.88d0,382.56d0,404.4d0&
    ,397.92d0,389.76d0,372.24d0,370.08d0,360.48d0,363.84d0,366.72d0,356.64d0,353.28d0,360.72d0,347.04d0,344.4d0&
    ,340.8d0,323.76d0,336d0,334.08d0,320.16d0,337.2d0,320.4d0,322.8d0,322.08d0,325.92d0,307.92d0,316.8d0,321.84d0&
    ,324.24d0,323.52d0,325.68d0,292.32d0,313.92d0,310.08d0,318d0,326.64d0,323.52d0,316.8d0,307.44d0,319.92d0&
    ,347.28d0,347.52d0,339.84d0,360.24d0,359.28d0,364.32d0,385.68d0,405.6d0,424.8d0,453.6d0,471.36d0,494.88d0&
    ,516.24d0,554.88d0,599.04d0,650.88d0,708d0,740.88d0,834d0,930.24d0,1017.84d0,1122.24d0,1205.04d0,1378.56d0&
    ,1550.64d0,1660.8d0,1817.52d0,2069.52d0,2318.16d0,2616.72d0,2955.36d0,3290.4d0,3692.4d0,4158d0,4562.16d0&
    ,5257.68d0,5794.56d0,6334.8d0,7001.28d0,7824.96d0,8860.32d0,9841.2d0,10914.5d0,12115.4d0,13405.2d0,14779d0&
    ,16167.6d0,17603d0,19346.2d0,21351.8d0,23003.3d0,24842.4d0,27254.2d0,29434.1d0,31615.2d0,33815.5d0,36099.1d0&
    ,38353.4d0,41224.1d0,43745.3d0,46324.3d0,49020d0,51531.8d0,53916.2d0,56724.5d0,60100.8d0,62818.8d0,65360.6d0&
    ,67806.2d0,70658.9d0,73354.6d0,76416.5d0,78586.8d0,81131.5d0,83319.4d0,85715.3d0,88069.2d0,90598.8d0,93285.4d0&
    ,95314.8d0,96830.6d0,98731.2d0,100234d0,101962d0,103897d0,105723d0,107655d0,109390d0,111037d0,112602d0,113752d0&
    ,115258d0,116892d0,118213d0,119634d0,120556d0,121927d0,122994d0,123688d0,125001d0,126072d0,127336d0,127966d0&
    ,128880d0,129381d0,130533d0,131112d0,132063d0,132699d0,133492d0,133914d0,134896d0,135341d0,135849d0,136408d0&
    ,136901d0,137552d0,137897d0,138563d0,139167d0,139450d0,139966d0,140586d0,140603d0,141414d0,141740d0,142155d0&
    ,142421d0,142771d0,143292d0,143657d0,144007d0,144152d0,144480d0,144885d0,145292d0,145577d0,145749d0,146160d0&
    ,146395d0,146701d0,147069d0,147222d0,147325d0,147729d0,147994d0,148311d0,148351d0,148595d0,149085d0,149235d0&
    ,149410d0,149652d0,149691d0,150113d0,150224d0,150520d0,150857d0,150918d0,151070d0,151249d0,151597d0,151657d0&
    ,151866d0,152284d0,152203d0,152615d0,152738d0,152794d0,153307d0,153168d0,153555d0,153254d0,153984d0,153941d0&
    ,153944d0,154474d0,154509d0,154532d0,154699d0,154935d0,155133d0,155225d0,155286d0,155711d0,155572d0,155842d0&
    ,156164d0,155966d0,156403d0,156372d0,156701d0,156783d0,156785d0,156965d0,157285d0,157316d0,157204d0,157655d0&
    ,157712d0,157666d0,157937d0,158303d0,157933d0,158292d0,158428d0,158466d0,158735d0,158821d0,158977d0,159058d0&
    ,159014d0,159334d0,159418d0,159558d0,159581d0,159788d0,159885d0,160025d0,160025d0,160340d0,160476d0,160355d0&
    ,160429d0,160484d0,160868d0,160921d0,161031d0,160936d0,161308d0,161146d0,161497d0,161550d0,161525d0,161538d0&
    ,161820d0,161886d0,161946d0,162046d0,162124d0,162379d0,162229d0,162292d0,162749d0,162746d0,162565d0,162768d0&
    ,163107d0,163039d0,163159d0,163307d0,163389d0,163139d0,163644d0,163537d0,163731d0,163768d0,163883d0,163975d0&
    ,163890d0,164216d0,163987d0,164583d0,164205d0,164341d0,164596d0,164591d0,164574d0,164795d0,164604d0,164917d0&
    ,164853d0,165142d0,165114d0,165097d0,165388d0,165055d0,165467d0,165694d0,165488d0,165559d0,165704d0,165923d0&
    ,165889d0,165752d0,165973d0,165987d0,166181d0,166057d0,166255d0,166110d0,166326d0,166529d0,166532d0,166228d0&
    ,166689d0,166531d0,166892d0,166678d0,166719d0,166880d0,166935d0,167209d0,166814d0,167112d0,167174d0,167020d0&
    ,167389d0,167190d0,167396d0,167306d0,167338d0,167677d0,167498d0,167504d0,167597d0,167830d0,167772d0,167759d0&
    ,167977d0,167920d0,167913d0,168058d0,168250d0,167783d0,168224d0,168107d0,168247d0,168282d0,168320d0,168486d0&
    ,168384d0,168377d0,168601d0,168225d0,168791d0,168670d0,168552d0,168664d0,168859d0,168705d0,168719d0,169208d0&
    ,168708d0,168908d0,168955d0,169131d0,168836d0,169000d0,169186d0,169145d0,169116d0,169160d0,169222d0,169329d0&
    ,169409d0,169385d0,169364d0,169373d0,169752d0,169405d0,169377d0,169725d0,169557d0,169542d0,169596d0,169701d0&
    ,169688d0,169675d0,169765d0,169755d0,169952d0,169886d0,169744d0,169752d0,170028d0,170033d0,169862d0,170050d0&
    ,169987d0,169985d0,170124d0,170163d0,170024d0,170418d0,169977d0,170153d0,170239d0,170262d0,170400d0,170004d0&
    ,170528d0,170350d0,170303d0,170331d0,170492d0,170392d0,170385d0,170418d0,170292d0,170515d0,170542d0,170396d0&
    ,170736d0,170502d0,170460d0,170628d0,170699d0,170452d0,170790d0,170585d0,170614d0,170704d0,170716d0,170615d0&
    ,170756d0,170833d0,170705d0,170618d0,170838d0,170739d0,170866d0,170752d0,170759d0,170640d0,171055d0,170670d0&
    ,170730d0,170943d0,170911d0,170876d0,170884d0,170866d0,171062d0,170868d0,171056d0,171133d0&
    ,170869d0,171071d0,170987d0 /)
    
    ! Local solution variables and delayed solution values:
    
    Yall=bet*Y(1)*Y(802)/24
    DO ii = 2,801
       Yall=Yall+Y(ii)/24
    ENDDO
    
    Itau=bet*Z(1,1)*Z(802,1)/24
    DO ii = 2,801
       Itau=Itau+Z(ii,1)/24
    ENDDO
    
    Zc=Pc(1)*bet*Y(1)*Y(802)/24
    DO jj = 2,801
       Zc=Zc+Y(jj)*Pc(jj)/24
    ENDDO
    
    Zi=Pi(1)*bet*Y(1)*Y(802)/24
    DO kk = 2,801
       Zi=Zi+Y(kk)*Pi(kk)/24
    ENDDO
    
    theta = 0.0d0
    meta = 0.0d0

    ! Local derivatives:
    
    DY(1)=Tm-rT*Y(1)-bet*(1-eps)*Y(1)*Y(802)+rho*(Yall-bet*(1-eps)*Y(1)*Y(802)/24)*Y(807)
    DY(2)=-delt*Y(2)-m*Y(807)*Y(2)-24*(Y(2)-bet*(1-eps)*Y(1)*Y(802))-rho*Y(2)*Y(807)
    DO j = 3,800
        DY(j)=-delt*Y(j)-m*Y(807)*Y(j)-24*(Y(j)-Y(j-1))-rho*Y(j)*Y(807)
    ENDDO
    DY(801)=-delt*Y(801)-m*Y(807)*Y(801)+24*Y(800)-rho*Y(801)*Y(807)
    DY(802)=rh1*Zc*(1-eta)-dc*Y(802)-kf*(1+theta)*Y(804)*Y(802)+kb*Y(805)
    DY(803)=rh2*Zi-di*Y(803)-kf*(1+theta)*Y(804)*Y(803)+kb*Y(806)
    DY(804)=pA*(Y(802)+Y(803))+(rA+meta)*Y(804)*(1-Y(804)/Am)-dA*Y(804)-kf*(1+theta)*Y(804)*Y(802)&
            +kb*Y(805)-kf*(1+theta)*Y(804)*Y(803)+kb*Y(806)
    DY(805)=kf*(1+theta)*Y(804)*Y(802)-kb*Y(805)-dxx*Y(805)
    DY(806)=kf*(1+theta)*Y(804)*Y(803)-kb*Y(806)-dxx*Y(806)
    DY(807)=lamE+alph*Itau*Z(807,1)/(ph1+Itau)-ks*(Y(808)**n)*Y(807)/(qc**n+Y(808)**n)-dE*Y(807)
    DY(808)=kapp*Yall/(ph2+Yall)-dq*Y(808)

    RETURN
  END SUBROUTINE DDES

END MODULE define_DDEs

!******************************************************************

PROGRAM HBVIntercellularModel 

  USE define_DDEs
  USE DDE_SOLVER_M

  IMPLICIT NONE

  ! The quantities
  !
  !   NEQN = number of equations
  !   NLAGS = number of delays
  !
  ! are defined in the module define_DDEs as PARAMETERs so 
  ! they can be used for dimensioning arrays here. They are 
  ! passed to the solver in the array NVAR.

  INTEGER, DIMENSION(2) :: NVAR = (/NEQN,NLAGS/)

  ! Constant delays and history:
  DOUBLE PRECISION, DIMENSION(NLAGS) :: DELAYS=(/ 5.75D0 /)
  DOUBLE PRECISION, DIMENSION(NEQN) :: HISTORY
  DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE :: I00
  DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE :: CYTOLITIC
  INTEGER :: ii
  DOUBLE PRECISION :: bet,m
  TYPE(DDE_SOL) :: SOL
  TYPE(DDE_OPTS) :: OPTS
  !
  !   SOL%NPTS         -- NPTS,number of output points.
  !
  !   SOL%T(NPTS)      -- values of independent variable, T.  
  !
  !   SOL%Y(NPTS,NEQN) -- values of dependent variable, Y,
  !                       corresponding to values of SOL%T. 
  !
  INTEGER :: I,J ! Local variables
  
  HISTORY(1) = 4.0d+7
  DO ii = 2,801
     HISTORY(ii) = 0.0d0
  ENDDO
  HISTORY(802) = 0.33d0
  HISTORY(803) = 0.0d0
  HISTORY(804) = 0.0d0
  HISTORY(805) = 0.0d0
  HISTORY(806) = 0.0d0
  HISTORY(807) = 0.0d0
  HISTORY(808) = 0.0d0
  
  bet = 1.25d-9
  m = 1.4d-4
  
  OPTS = DDE_SET(MAX_STEPS=10000000)!,HINIT=1.0d-1,RE=1.0d-1,AE=1.0d-1)

  SOL = DDE_SOLVER(NVAR,DDES,DELAYS,HISTORY,TSPAN=(/ 0D0,301D0 /),OPTIONS=OPTS)
  ! WRITE(*,*) "It is done"
  ! Was the solver successful?
  IF (SOL%FLAG == 0) THEN

     ! Write the solution to a file for subsequent plotting in Matlab.
     ALLOCATE(I00(SOL%NPTS))
     ALLOCATE(CYTOLITIC(SOL%NPTS))
     DO ii = 1,SOL%NPTS
        I00(ii) = bet*SOL%Y(ii,1)*SOL%Y(ii,802)/24
     ENDDO
     DO ii = 2,801
        I00 = I00 + SOL%Y(:,ii)/24
     ENDDO
     DO ii = 1,SOL%NPTS
        CYTOLITIC(ii) = m*I00(ii)*SOL%Y(ii,807)
     ENDDO 
     ! HBVIntercellularModel_median
     OPEN(UNIT=3, FILE='HBVIntercellularModel.dat')
!     DO I = 1,SOL%NPTS
!        WRITE(UNIT=3,FMT='(809D14.5)') SOL%T(I),(SOL%Y(I,J),J=1,NEQN)
!     ENDDO
!     CLOSE(UNIT=3)

     DO J = 1,401
      DO I = 1,SOL%NPTS
        IF ( SOL%T(I) .GE. (J-1) ) THEN
           !OPEN(UNIT=3, FILE=file_out, ACCESS='APPEND', STATUS='UNKNOWN')
           WRITE(UNIT=3,FMT='(11D14.5)') SOL%T(I),SOL%Y(I,1),I00(I),SOL%Y(I,802),SOL%Y(I,803),SOL%Y(I,804)&
                                         ,SOL%Y(I,805),SOL%Y(I,806),SOL%Y(I,807),SOL%Y(I,808),CYTOLITIC(I)
           !CLOSE(UNIT=3)
           EXIT ! or use go to
        ENDIF
      ENDDO
    ENDDO

!     DO I = 1,SOL%NPTS
!        WRITE(UNIT=3,FMT='(11D14.5)') SOL%T(I),SOL%Y(I,1),I00(I),SOL%Y(I,802),SOL%Y(I,803),SOL%Y(I,804)&
!                                       ,SOL%Y(I,805),SOL%Y(I,806),SOL%Y(I,807),SOL%Y(I,808),CYTOLITIC(I)
!     ENDDO
     CLOSE(UNIT=3)
     
     PRINT *,' Normal return from DDE_SOLVER with results'
     PRINT *," written to the file 'HBVIntercellularModel.dat'."
     PRINT *,' '
     PRINT *,' These results can be accessed in Matlab'
     PRINT *,' and plotted by'
     PRINT *,' '
     PRINT *," >> [t,y] = HBVIntercellularModel;"
     PRINT *,' '

  ELSE

     PRINT *,' Abnormal return from DDE_SOLVER with FLAG = ',&
     SOL%FLAG

  ENDIF
  
  DEALLOCATE(I00)
  DEALLOCATE(CYTOLITIC)
  ! Integration statistics:
  CALL PRINT_STATS(SOL)

END PROGRAM HBVIntercellularModel
